<script>
    // Previous fallbackQuestions remain the same

    let currentRound = 1;
    let currentQuestion = 0;
    let score = 0;
    let timeBonus = 0;
    let currentQuestions = [];
    let answerSelected = false;
    let timer;
    let timeLeft = 30;
    let lifelines = {
        fiftyFifty: true,
        hint: true,
        timeExtension: true
    };
    let roundScores = {
        correct: 0,
        time: 0,
        streak: 0
    };
    let currentStreak = 0;

    // DOM elements
    const elements = {
        timer: document.getElementById('timer'),
        question: document.getElementById('question'),
        options: document.getElementById('options'),
        hintText: document.getElementById('hintText'),
        explanation: document.getElementById('explanation'),
        nextButton: document.getElementById('nextButton'),
        score: document.getElementById('score'),
        round: document.getElementById('round'),
        questionNumber: document.getElementById('questionNumber'),
        roundComplete: document.getElementById('roundComplete'),
        scoreBreakdown: document.getElementById('scoreBreakdown'),
        nextRoundButton: document.getElementById('nextRoundButton'),
        fiftyFifty: document.getElementById('fiftyFifty'),
        hint: document.getElementById('hint'),
        timeExtension: document.getElementById('timeExtension')
    };

    function startTimer() {
        clearInterval(timer);
        timeLeft = 30;
        elements.timer.textContent = timeLeft;
        elements.timer.style.color = '#dc3545';
        
        timer = setInterval(() => {
            timeLeft--;
            elements.timer.textContent = timeLeft;
            
            if (timeLeft <= 10) {
                elements.timer.style.color = 'red';
            }
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                handleTimeout();
            }
        }, 1000);
    }

    function handleTimeout() {
        if (!answerSelected) {
            const options = document.querySelectorAll('.option');
            const question = currentQuestions[currentQuestion];
            options[question.correct].classList.add('correct');
            options.forEach(option => option.disabled = true);
            elements.explanation.textContent = question.explanation;
            elements.explanation.style.display = 'block';
            answerSelected = true;
            elements.nextButton.disabled = false;
            currentStreak = 0;
        }
    }

    // Lifeline handlers
    elements.fiftyFifty.onclick = () => {
        if (!lifelines.fiftyFifty || answerSelected) return;
        
        const options = document.querySelectorAll('.option');
        const question = currentQuestions[currentQuestion];
        let removed = 0;
        let indices = [...Array(options.length).keys()]
            .filter(i => i !== question.correct)
            .sort(() => Math.random() - 0.5);
        
        indices.slice(0, 2).forEach(index => {
            options[index].style.display = 'none';
        });
        
        lifelines.fiftyFifty = false;
        elements.fiftyFifty.disabled = true;
    };

    elements.hint.onclick = () => {
        if (!lifelines.hint || answerSelected) return;
        
        const question = currentQuestions[currentQuestion];
        elements.hintText.textContent = `Hint: ${question.explanation.split(':')[1]}`;
        elements.hintText.style.display = 'block';
        
        lifelines.hint = false;
        elements.hint.disabled = true;
    };

    elements.timeExtension.onclick = () => {
        if (!lifelines.timeExtension || answerSelected) return;
        
        timeLeft += 30;
        elements.timer.textContent = timeLeft;
        elements.timer.style.color = '#dc3545';
        
        lifelines.timeExtension = false;
        elements.timeExtension.disabled = true;
    };

    function calculateScore(isCorrect) {
        let questionScore = 0;
        
        if (isCorrect) {
            // Base score based on difficulty
            questionScore += currentRound * 10;
            
            // Time bonus
            timeBonus = Math.max(0, timeLeft);
            questionScore += timeBonus;
            
            // Streak bonus
            currentStreak++;
            if (currentStreak >= 3) {
                questionScore += 15;
            }
            
            roundScores.correct += questionScore;
            roundScores.time += timeBonus;
            if (currentStreak >= 3) {
                roundScores.streak += 15;
            }
        } else {
            currentStreak = 0;
        }
        
        return questionScore;
    }

    function selectOption(index) {
        if (answerSelected) return;

        clearInterval(timer);
        const question = currentQuestions[currentQuestion];
        const options = document.querySelectorAll('.option');
        
        options[index].classList.add('selected');
        options[question.correct].classList.add('correct');
        
        const isCorrect = index === question.correct;
        if (isCorrect) {
            score += calculateScore(true);
            elements.score.textContent = score;
        } else {
            options[index].classList.add('incorrect');
            calculateScore(false);
        }

        elements.explanation.textContent = question.explanation;
        elements.explanation.style.display = 'block';
        answerSelected = true;
        elements.nextButton.disabled = false;
        options.forEach(option => option.disabled = true);
    }

    function showRoundSummary() {
        elements.scoreBreakdown.innerHTML = `
            <h3>Round ${currentRound} Summary</h3>
            <p>Base Score: ${roundScores.correct}</p>
            <p>Time Bonuses: ${roundScores.time}</p>
            <p>Streak Bonuses: ${roundScores.streak}</p>
            <p>Total Round Score: ${roundScores.correct + roundScores.time + roundScores.streak}</p>
        `;
        
        // Reset round scores
        roundScores = {
            correct: 0,
            time: 0,
            streak: 0
        };
    }

    // Previous functions (getDifficulty, fetchQuestions) remain the same

    async function startRound(round) {
        // Reset lifelines
        lifelines = {
            fiftyFifty: true,
            hint: true,
            timeExtension: true
        };
        elements.fiftyFifty.disabled = false;
        elements.hint.disabled = false;
        elements.timeExtension.disabled = false;
        
        const difficulty = getDifficulty(round);
        currentQuestions = await fetchQuestions(difficulty);
        currentQuestion = 0;
        displayQuestion();
        elements.roundComplete.style.display = 'none';
        startTimer();
    }

    function displayQuestion() {
        const question = currentQuestions[currentQuestion];
        elements.question.textContent = decodeHTML(question.question);
        elements.options.innerHTML = '';
        elements.explanation.style.display = 'none';
        elements.hintText.style.display = 'none';
        answerSelected = false;
        elements.nextButton.disabled = true;

        question.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'option';
            button.textContent = decodeHTML(option);
            button.onclick = () => selectOption(index);
            elements.options.appendChild(button);
        });

        elements.questionNumber.textContent = currentQuestion + 1;
        elements.round.textContent = currentRound;
        startTimer();
    }

    elements.nextButton.onclick = () => {
        currentQuestion++;
        
        if (currentQuestion >= 5) {
            showRoundSummary();
            elements.roundComplete.style.display = 'block';
            document.getElementById('quizContainer').style.display = 'none';
        } else {
            displayQuestion();
        }
    };

    elements.nextRoundButton.onclick = () => {
        currentRound++;
        if (currentRound <= 3) {
            document.getElementById('quizContainer').style.display = 'block';
            startRound(currentRound);
        } else {
            alert(`Quiz completed! Final score: ${score}`);
            location.reload();
        }
    };

    // Start the quiz
    startRound(1);
</script>
